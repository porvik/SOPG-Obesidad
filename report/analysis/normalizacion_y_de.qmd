### Normalización y Expresión Diferencial

#### DESeq2
```{r}
#readRenviron("/home/vikto/work/bioinf/sopg/SOPG-Obesidad/report/.Renviron")

library(dplyr)
library(DESeq2)

PROJECT_DIR <- Sys.getenv("PROJECT_DIR")

# Cargamos los datos de expresión y metadatos
counts <- read.csv(paste0(PROJECT_DIR, "/results/counts/using_R/matriz_cuentas_crudas.csv"), row.names=1)
coldata <- read.csv(paste0(PROJECT_DIR, "/data/design_metadata_corrected.csv"), row.names=1)

# Factores
coldata$condition <- factor(
  coldata$condition,
  levels = c(1, 2),
  labels = c("control", "obese")
)

coldata$sex <- factor(
  coldata$sex,
  levels = c(1, 2),
  labels = c("male", "female")
)

# Numérica (explícito, por higiene)
coldata$age <- as.numeric(coldata$age)

deseq2_exec <- function(counts, coldata, design, outfile)
{
  # Creamos el objeto DESeqDataSet con el diseño experimental que queremos comparar
  dds <- DESeqDataSetFromMatrix(countData = counts, colData = coldata, design = design)
  
  # Normalización y análisis diferencial
  dds <- DESeq(dds)
  res <- results(dds)
  
  # Filtramos los genes con los usados
  res_tested <- res[!is.na(res$pvalue), ]
  write.csv(res_tested, paste0(PROJECT_DIR, "/results/deseq2/", outfile ,".csv"))

  saveRDS(dds, paste0(PROJECT_DIR, "/results/deseq2/", outfile ,".rds"))
}

deseq2_exec(counts = counts, coldata = coldata, design = ~ condition, "de_condition")
deseq2_exec(counts = counts, coldata = coldata, design = ~ sex + age + condition, "de_sex_age_condition")
```